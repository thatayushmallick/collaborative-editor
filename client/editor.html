<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Collaborative Text Editor</title>
  <link href="node_modules/quill/dist/quill.snow.css" rel="stylesheet">
  <style>
    #editor { height: 500px; margin: 20px; }
  </style>
</head>
<body>
  <div id="editor"></div>

  <script src="node_modules/yjs/dist/yjs.min.js"></script>
  <script src="node_modules/y-websocket/bin/y-websocket.js"></script>
  <script src="node_modules/quill/dist/quill.min.js"></script>
  <script src="node_modules/y-quill/y-quill.js"></script>

  <script>
    console.log('Editor script starting');
    try {
      const token = localStorage.getItem('token');
      console.log('Token:', token);
      if (!token) {
        console.log('No token, redirecting to login');
        window.location.href = 'login.html';
        return;
      }

      console.log('Initializing Y.Doc');
      const ydoc = new Y.Doc();
      console.log('Connecting to WebSocket ws://localhost:1235');
      const provider = new WebsocketProvider('ws://localhost:1235', 'my-room', ydoc, {
        connectOpts: { query: { token } }
      });
      console.log('Getting Y.Text');
      const ytext = ydoc.getText('quill');
      console.log('Initializing Quill editor');
      const editor = new Quill('#editor', {
        theme: 'snow',
        placeholder: 'Start typing here...'
      });
      console.log('Binding Yjs to Quill');
      const binding = new YQuillBinding(ytext, editor, provider.awareness);

      provider.on('status', event => {
        console.log('WebSocket status:', event.status);
      });

      provider.on('error', err => {
        console.error('WebSocket provider error:', err);
      });
    } catch (err) {
      console.error('Editor script error:', err);
    }
  </script>
</body>
</html>